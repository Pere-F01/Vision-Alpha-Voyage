window.WebPushNotification = window.WebPushNotification || function () {
    var self = this;
    this.messaging = null;
    this.loading = false;
    this.config = {
        apiKey: "AIzaSyCkepPdql5iVAaluJ3PpdjsOqW_DRd065M",
        authDomain: "webnotify-b7130.firebaseapp.com",
        projectId: "webnotify-b7130",
        storageBucket: "webnotify-b7130.appspot.com",
        messagingSenderId: "744810671619",
        appId: "1:744810671619:web:ef082721b8802e30b86836"
    };

    // Инициализиция экземпляра приложения Firebase
    this.initializeFirebase = function (config = {}) {
        firebase.initializeApp(config);
    };

    // Получяем Messaging службу для приложения по умолчанию
    this.getMessagingFirebase = function () {
        return firebase.messaging();
    };

    // Проверка поддержки пушей
    this.checkSupport = function () {
        return window.location.protocol === 'https:'
            && 'Notification' in window
            && 'serviceWorker' in navigator
            && 'localStorage' in window
            && 'fetch' in window
            && 'postMessage' in window;
    };

    // Обработка ошибок
    this.handleError = function () {
        if (window.location.protocol !== 'https:') {
            console.error('Is not from HTTPS');
        } else if (!('Notification' in window)) {
            console.error('Notification not supported');
        } else if (!('serviceWorker' in navigator)) {
            console.error('ServiceWorker not supported');
        } else if (!('localStorage' in window)) {
            console.error('LocalStorage not supported');
        } else if (!('fetch' in window)) {
            console.error('fetch not supported');
        } else if (!('postMessage' in window)) {
            console.error('postMessage not supported');
        }

        console.warn('This browser does not support desktop notification.');
        console.log('Is HTTPS', window.location.protocol === 'https:');
        console.log('Support Notification', 'Notification' in window);
        console.log('Support ServiceWorker', 'serviceWorker' in navigator);
        console.log('Support LocalStorage', 'localStorage' in window);
        console.log('Support fetch', 'fetch' in window);
        console.log('Support postMessage', 'postMessage' in window);
    };

    // Запрос TOKEN
    this.getToken = function () {
        if (!!self.messaging) {
            // в новой версии firebase разрешения запрашиваются по умолчанию
            self.messaging.getToken({vapidKey: 'BKONF7f5GjEiMPyIgcU5lhb-9NIidV62IFpn9Z1sqhnNoPXEmYZnPnHjhyfIHNlT0JQQOxwqBGDvJ8eujhDyzJ4'}).then((token) => {
                if (token) {
                    console.log('[fcm]', token);
                    self.sendTokenToServer(token);
                } else {
                    console.warn('[fcm] token is empty');
                }
            }).catch((error) => {
                console.error('[fcm] failed to get token', error);
            });
        } else {
            console.error('[fcm] failed to init app');
        }
    };

    // Отправка TOKEN на сервер
    this.sendTokenToServer = function (token) {
        var topic = (window.rbthConf && window.rbthConf.lang) || 'test';
        fetch('https://push.russiabeyond.com/fcm/register/' + topic + '/' + token, {
            'method': 'POST',
            'Content-Type': 'application/json'
        }).then((res) => {
            console.log('[fcm] token subscribed to topic', topic);
        }).catch((error) => {
            console.error('[fcm] failed to subscribe token to topic', error);
        });
    };

    // init
    this.init = function () {
        self.initializeFirebase(self.config);
        self.messaging = self.getMessagingFirebase();
        self.getToken();
    };

    // addFirebaseScript
    this.addFirebaseScript = function () {
        var s = document.getElementsByTagName('script')[0];

        var p1 = document.createElement('script');
        p1.async = 'async';
        p1.src = 'https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js';
        s.parentNode.insertBefore(p1, s);

        p1.onload = function () {
            console.debug(`[fcm] app loaded`);

            var p2 = document.createElement('script');
            p2.async = 'async';
            s.parentNode.insertBefore(p2, s);
            p2.src = 'https://www.gstatic.com/firebasejs/11.0.1/firebase-messaging-compat.js';
                p2.onload = function () {
                console.debug(`[fcm] messaging loaded`);
                self.init();
            };
        };
    };

    // created
    this.created = function () {
        if (self.checkSupport()) {
            self.addFirebaseScript();
        } else {
            self.handleError();
        }
    };

    return this;
};

new window.WebPushNotification().created();
